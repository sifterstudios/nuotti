@page "/question"
@inject AudienceHubClient Hub
@inject NavigationManager Nav
@inject ISnackbar Snackbar
@inject FeedbackService Feedback
@using Nuotti.Contracts.V1.Message
@using Nuotti.Contracts.V1.Model
@using Nuotti.Audience.Services
@implements IDisposable

<PageTitle>@(_isWaiting ? "Waiting Room" : "Question") - Nuotti</PageTitle>

<!-- Flow Banner -->
<FlowBanner GameState="@Hub.CurrentGameState" />

<div class="question-container">
    <MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
        @if (Hub.CurrentQuestion is QuestionPushed q)
        {
            <!-- Active Question View -->
            <div class="question-active" role="main" aria-labelledby="current-question">
                <MudText Typo="Typo.h3" 
                         Align="Align.Center" 
                         Class="mb-6 bounce-in"
                         Style="font-weight: 700; line-height: 1.3;"
                         id="current-question"
                         aria-live="polite">
                    @q.Text
                </MudText>

                <div class="options-grid @GetOptionsGridClass(q.Options.Length)" 
                     role="group" 
                     aria-labelledby="current-question"
                     aria-describedby="answer-instructions">
                    <div id="answer-instructions" class="sr-only">
                        Choose one of the following @q.Options.Length options to answer the question.
                        @if (_hasAnswered)
                        {
                            <span>You have already submitted your answer.</span>
                        }
                    </div>
                    @for (var i = 0; i < q.Options.Length; i++)
                    {
                        var idx = i;
                        var color = GetOptionColor(idx);
                        var icon = GetOptionIcon(idx);
                        
                        <div class="option-container">
                            <MudButton Variant="Variant.Filled" 
                                       Color="@color" 
                                       Size="Size.Large"
                                       FullWidth="true"
                                       StartIcon="@icon"
                                       OnClick="(() => Submit(idx))"
                                       Disabled="@_hasAnswered"
                                       Class="@($"option-button option-{idx + 1} slide-up")"
                                       Style="@($"animation-delay: {idx * 0.1}s;")"
                                       id="@($"option-{idx + 1}")"
                                       aria-label="@($"Option {idx + 1}: {q.Options[idx]}")"
                                       aria-describedby="@($"option-{idx + 1}-status")")">
                                <div class="option-content">
                                    <div class="option-number">
                                        @(idx + 1)
                                    </div>
                                    <div class="option-text">
                                        <MudText Typo="Typo.body1" Style="font-weight: 600; line-height: 1.3;">
                                            @q.Options[idx]
                                        </MudText>
                                    </div>
                                </div>
                            </MudButton>
                            <div id="@($"option-{idx + 1}-status")" class="sr-only">
                                @if (_hasAnswered)
                                {
                                    <span>Answer submitted</span>
                                }
                                else
                                {
                                    <span>Available to select</span>
                                }
                            </div>
                        </div>
                    }
                </div>

                @if (_hasAnswered)
                {
                    <MudAlert Severity="Severity.Success" 
                              Class="mt-4" 
                              Variant="Variant.Filled"
                              Icon="@Material.Filled.CheckCircle"
                              role="status"
                              aria-live="polite">
                        Answer submitted! Waiting for others...
                    </MudAlert>
                }
            </div>
        }
        else
        {
            <!-- Waiting Room View -->
            <div class="waiting-room">
                <div class="text-center mb-6">
                    <div class="waiting-icon mb-4 pulse">
                        🎵
                    </div>
                    <MudText Typo="Typo.h3" Style="font-weight: 700;" Class="mb-2">
                        Waiting Room
                    </MudText>
                    <MudText Typo="Typo.h6" Color="Color.Secondary">
                        Get ready! The quiz will start soon...
                    </MudText>
                </div>

                <!-- Session Info Card -->
                <MudPaper Elevation="4" Class="pa-4 mb-4" Style="border-radius: 16px; background: linear-gradient(135deg, rgba(var(--mud-palette-primary-rgb), 0.1) 0%, rgba(var(--mud-palette-secondary-rgb), 0.1) 100%);">
                    <div class="d-flex align-items-center justify-space-between">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="text-transform: uppercase; font-weight: 700;">
                                Session Code
                            </MudText>
                            <MudText Typo="Typo.h4" Style="font-weight: 800; letter-spacing: 2px;">
                                @Hub.SessionCode
                            </MudText>
                        </div>
                        <MudIcon Icon="@Material.Filled.QrCode2" 
                                 Size="Size.Large" 
                                 Color="Color.Primary" />
                    </div>
                </MudPaper>

                <!-- Participants List -->
                <ParticipantsList Participants="@_participantsList" 
                                  Title="In the Room"
                                  EmptyMessage="Be the first to join!" 
                                  Class="mb-4" />

                <!-- Tips Card -->
                <MudPaper Elevation="0" Class="pa-4" Style="background: transparent; border: 2px dashed var(--mud-palette-divider); border-radius: 16px;">
                    <div class="d-flex align-items-center mb-3">
                        <MudIcon Icon="@Material.Filled.Lightbulb" Color="Color.Warning" Class="mr-2" />
                        <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                            Quick Tips
                        </MudText>
                    </div>
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.body2">
                            <MudIcon Icon="@Material.Filled.Speed" Size="Size.Small" Class="mr-1" />
                            Answer quickly for bonus points!
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <MudIcon Icon="@Material.Filled.MusicNote" Size="Size.Small" Class="mr-1" />
                            Listen carefully to the audio clips
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <MudIcon Icon="@Material.Filled.EmojiEvents" Size="Size.Small" Class="mr-1" />
                            Compete with others for the top score!
                        </MudText>
                    </MudStack>
                </MudPaper>
            </div>
        }

        <!-- Action Buttons -->
        <div class="mt-6 d-flex justify-space-between align-items-center">
            <MudButton Variant="Variant.Text" 
                       StartIcon="@Material.Filled.ExitToApp"
                       OnClick="GoHome"
                       Color="Color.Default">
                Leave Session
            </MudButton>
            
            @if (_showDevTools)
            {
                <MudButton Variant="Variant.Text" 
                           StartIcon="@Material.Filled.BugReport"
                           OnClick="@(() => _showDevPanel = !_showDevPanel)"
                           Color="Color.Secondary">
                    Dev Tools
                </MudButton>
            }
            else
            {
                <MudLink Typo="Typo.caption" OnClick="@(() => _showDevTools = true)">
                    Show dev tools
                </MudLink>
            }
        </div>

        <!-- Developer Panel (Collapsible) -->
        @if (_showDevPanel && _showDevTools)
        {
            <MudPaper Class="mt-4 pa-4" Elevation="2" Style="border-radius: 12px;">
                <MudText Typo="Typo.subtitle1" GutterBottom="true" Style="font-weight: 600;">
                    🛠️ Developer Tools
                </MudText>
                <MudDivider Class="mb-3" />
                
                <MudText Typo="Typo.body2" Class="mb-2" Style="font-weight: 600;">Test Audio Playback</MudText>
                <MudStack Row="true" Spacing="2" Class="mb-3">
                    <MudTextField @bind-Value="fileUrl" 
                                  Variant="Variant.Outlined" 
                                  Label="Audio URL"
                                  FullWidth="true"
                                  Dense="true" />
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               OnClick="RequestPlay"
                               Style="min-width: 120px;">
                        Play
                    </MudButton>
                </MudStack>
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Sends play request to projector via backend. AudioEngine in the same session will play it.
                </MudText>
            </MudPaper>
        }
    </MudContainer>
</div>

<style>
    .question-container {
        min-height: calc(100vh - 64px);
        padding: 24px 0;
    }
    
    /* Question text responsive sizing */
    .question-active .mud-typography-h3 {
        font-size: clamp(1.5rem, 4vw + 1rem, 2.5rem) !important;
        min-height: 3em; /* Reserve space to prevent layout shift */
        line-height: 1.3;
    }
    
    .waiting-icon {
        font-size: clamp(2rem, 8vw + 1rem, 5rem);
        line-height: 1;
    }
    
    /* Options Grid - Adaptive Layout */
    .options-grid {
        display: grid;
        gap: 16px;
        margin-bottom: 24px;
        width: 100%;
    }
    
    .options-grid.two-options {
        grid-template-columns: 1fr 1fr;
    }
    
    .options-grid.three-options {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
    }
    
    .options-grid.three-options .option-container:nth-child(3) {
        grid-column: 1 / -1;
    }
    
    .options-grid.four-options {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
    }
    
    .options-grid.one-option {
        grid-template-columns: 1fr;
        max-width: 400px;
        margin: 0 auto 24px auto;
    }
    
    /* Option Button Styling */
    .option-button {
        text-transform: none !important;
        letter-spacing: normal !important;
        min-height: 72px !important; /* Ensure 44px+ tap target with padding */
        border-radius: 16px !important;
        font-size: clamp(0.9rem, 2vw + 0.5rem, 1.1rem) !important;
        font-weight: 600 !important;
        padding: 16px !important;
        position: relative;
        overflow: hidden;
        transition: all 0.2s ease !important;
    }
    
    .option-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }
    
    .option-button:active:not(:disabled) {
        transform: translateY(0px);
    }
    
    .option-content {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        width: 100%;
        gap: 12px;
    }
    
    .option-number {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        width: clamp(28px, 4vw + 8px, 32px);
        height: clamp(28px, 4vw + 8px, 32px);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: clamp(0.8rem, 1.5vw + 0.3rem, 1rem);
        flex-shrink: 0;
    }
    
    .option-text {
        flex: 1;
        text-align: left;
        min-height: 2.5em; /* Reserve space for text to prevent layout shift */
        display: flex;
        align-items: center;
    }
    
    /* Mobile Optimizations */
    @media (max-width: 768px) {
        .options-grid {
            gap: 12px;
        }
        
        .options-grid.three-options,
        .options-grid.four-options {
            grid-template-columns: 1fr;
            grid-template-rows: repeat(auto, 1fr);
        }
        
        .options-grid.three-options .option-container:nth-child(3) {
            grid-column: auto;
        }
        
        .option-button {
            min-height: 64px !important;
            padding: 12px 16px !important;
            font-size: clamp(0.875rem, 2vw + 0.4rem, 1rem) !important;
        }
        
        .option-number {
            width: clamp(24px, 3vw + 6px, 28px);
            height: clamp(24px, 3vw + 6px, 28px);
            font-size: clamp(0.75rem, 1.2vw + 0.25rem, 0.9rem);
        }
        
        .question-container .mud-container {
            padding-left: 16px;
            padding-right: 16px;
        }
    }
    
    @media (max-width: 480px) {
        .waiting-icon {
            font-size: clamp(2rem, 6vw + 0.5rem, 3.5rem);
        }
        
        .options-grid {
            gap: 10px;
        }
        
        .option-button {
            min-height: 56px !important;
            padding: 10px 12px !important;
            border-radius: 12px !important;
            font-size: clamp(0.875rem, 2vw + 0.3rem, 0.95rem) !important;
        }
        
        .option-number {
            width: clamp(20px, 2.5vw + 4px, 24px);
            height: clamp(20px, 2.5vw + 4px, 24px);
            font-size: clamp(0.7rem, 1vw + 0.2rem, 0.8rem);
        }
        
        .option-content {
            gap: 8px;
        }
    }
    
    /* Safe area for devices with notches */
    @supports (padding: max(0px)) {
        .question-container {
            padding-left: max(16px, env(safe-area-inset-left));
            padding-right: max(16px, env(safe-area-inset-right));
        }
    }
    
    /* High contrast mode support */
    @media (prefers-contrast: high) {
        .option-button {
            border: 2px solid currentColor !important;
        }
        
        .option-number {
            background: currentColor !important;
            color: var(--mud-palette-surface) !important;
        }
    }
    
    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
        .option-button {
            transition: none !important;
        }
        
        .option-button:hover:not(:disabled) {
            transform: none;
        }
    }
    
    /* Screen reader only content */
    .sr-only {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
    }
    
    /* Focus management */
    .option-button:focus {
        outline: 3px solid var(--mud-palette-primary) !important;
        outline-offset: 2px !important;
    }
    
    /* High contrast mode improvements */
    @media (prefers-contrast: high) {
        .option-button:focus {
            outline: 3px solid currentColor !important;
        }
        
        .option-text {
            font-weight: 700 !important;
        }
    }
</style>

@code {
    private string fileUrl = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3";
    private bool _hasAnswered = false;
    private bool _showDevPanel = false;
    private bool _showDevTools = false;
    private List<string> _participantsList = new();
    private bool _isWaiting => Hub.CurrentQuestion is null;
    private DateTime _lastSubmissionAttempt = DateTime.MinValue;

    protected override async Task OnInitializedAsync()
    {
        Hub.QuestionPushed += OnQuestionPushed;
        Hub.ParticipantsChanged += OnParticipantsChanged;
        Hub.GameStateChanged += OnGameStateChanged;
        UpdateParticipantsList();
        
        // Initialize feedback service
        await Feedback.InitializeAsync();
        
        // Fetch current game state if we have a session
        if (!string.IsNullOrEmpty(Hub.SessionCode))
        {
            await Hub.FetchGameStateAsync();
        }
    }

    private async void OnQuestionPushed(QuestionPushed _)
    {
        _hasAnswered = false; // Reset for new question
        await InvokeAsync(StateHasChanged);
    }

    private void OnParticipantsChanged()
    {
        UpdateParticipantsList();
        InvokeAsync(StateHasChanged);
    }

    private async void OnGameStateChanged(GameStateSnapshot gameState)
    {
        await InvokeAsync(async () =>
        {
            // Check if we just entered the reveal phase and trigger confetti for correct answers
            if (gameState.Phase == Phase.Reveal && Hub.CurrentGameState?.Phase != Phase.Reveal)
            {
                await HandleAnswerReveal(gameState);
            }
            
            StateHasChanged();
            CheckForPhaseTransition(gameState);
        });
    }

    private async Task HandleAnswerReveal(GameStateSnapshot gameState)
    {
        // This is a simplified version - in a real implementation, you'd need to track
        // the player's answer and compare it with the correct answer from the game state
        // For now, we'll trigger confetti if the player submitted an answer
        if (_hasAnswered)
        {
            // Simulate checking if the answer was correct (you'd get this from the server)
            var isCorrect = Random.Shared.NextDouble() > 0.5; // 50% chance for demo
            
            if (isCorrect)
            {
                await Feedback.TriggerConfettiAsync(ConfettiType.Success);
                await Feedback.TriggerHapticFeedbackAsync(HapticType.Heavy);
            }
        }
    }

    private void CheckForPhaseTransition(GameStateSnapshot gameState)
    {
        // Navigate to ranking page during reveal, intermission, or finished phases
        if (gameState.Phase == Phase.Reveal || 
            gameState.Phase == Phase.Intermission || 
            gameState.Phase == Phase.Finished)
        {
            Nav.NavigateTo("/ranking");
        }
    }

    private void UpdateParticipantsList()
    {
        _participantsList = Hub.Participants.ToList();
    }

    public void Dispose()
    {
        Hub.QuestionPushed -= OnQuestionPushed;
        Hub.ParticipantsChanged -= OnParticipantsChanged;
        Hub.GameStateChanged -= OnGameStateChanged;
    }

    private async Task Submit(int index)
    {
        if (_hasAnswered) return;
        
        // Anti-spam: Debounce rapid submissions
        var timeSinceLastAttempt = DateTime.Now - _lastSubmissionAttempt;
        if (timeSinceLastAttempt < TimeSpan.FromMilliseconds(500))
        {
            return; // Ignore rapid clicks
        }
        
        _lastSubmissionAttempt = DateTime.Now;
        
        try
        {
            // Provide haptic feedback on submission
            await Feedback.TriggerHapticFeedbackAsync(HapticType.Medium);
            
            await Hub.SubmitAnswerAsync(index);
            _hasAnswered = true;
            
            // Pulse animation on the submitted button
            await Feedback.TriggerPulseAnimationAsync($"option-{index + 1}");
            
            Snackbar.Add("Answer submitted successfully!", Severity.Success);
        }
        catch (Exception ex)
        {
            // Shake animation on error
            await Feedback.TriggerShakeAnimationAsync($"option-{index + 1}");
            Snackbar.Add($"Failed to submit answer: {ex.Message}", Severity.Error);
        }
    }

    private async Task RequestPlay()
    {
        try
        {
            await Hub.RequestPlayAsync(fileUrl);
            Snackbar.Add("Play request sent to projector", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to send play request: {ex.Message}", Severity.Error);
        }
    }

    private void GoHome()
    {
        Nav.NavigateTo("/");
    }

    private Color GetOptionColor(int index)
    {
        return index switch
        {
            0 => Color.Primary,
            1 => Color.Secondary,
            2 => Color.Tertiary,
            3 => Color.Info,
            _ => Color.Default
        };
    }

    private string GetOptionIcon(int index)
    {
        return index switch
        {
            0 => Material.Filled.LooksOne,
            1 => Material.Filled.LooksTwo,
            2 => Material.Filled.Looks3,
            3 => Material.Filled.Looks4,
            _ => Material.Filled.CheckCircle
        };
    }
    
    private string GetOptionsGridClass(int optionCount)
    {
        return optionCount switch
        {
            1 => "one-option",
            2 => "two-options",
            3 => "three-options",
            4 => "four-options",
            _ => "four-options" // Default to 4-option layout for more than 4 options
        };
    }
}
