@page "/question"
@using Nuotti.Audience.Services
@inject AudienceHubClient Hub
@inject NavigationManager Nav
@implements IDisposable

<PageTitle>Question</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    @if (Hub.CurrentQuestion is Nuotti.Contracts.QuestionPushed q)
    {
        <MudText Typo="Typo.h4" GutterBottom="true">@q.Text</MudText>

        <MudStack Spacing="3">
            @for (var i = 0; i < q.Options.Length; i++)
            {
                var idx = i;
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Primary" 
                           Size="Size.Large"
                           FullWidth="true"
                           StartIcon="@($"{idx + 1}")"
                           OnClick="(() => Submit(idx))"
                           Class="text-start justify-start"
                           Style="min-height: 64px;">
                    @q.Options[idx]
                </MudButton>
            }
        </MudStack>
    }
    else
    {
        <MudContainer Class="py-5 text-center">
            <MudText Typo="Typo.body1" Color="Color.Secondary">Waiting for a question...</MudText>
        </MudContainer>
    }

    <MudStack Row="true" Class="mt-4">
        <MudButton Variant="Variant.Text" OnClick="GoHome">Change session</MudButton>
    </MudStack>

    <MudPaper Class="mt-5 pa-4" Elevation="1">
        <MudText Typo="Typo.subtitle1" GutterBottom="true">Test audio (asks projector to play)</MudText>
        <MudStack Row="true" Spacing="2" Justify="Justify.Center">
            <MudTextField @bind-Value="fileUrl" 
                          Variant="Variant.Outlined" 
                          FullWidth="true" />
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Success" 
                       OnClick="RequestPlay">
                Play on projector
            </MudButton>
        </MudStack>
        <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
            Projector will call backend /api/play. AudioEngine in same session should play.
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private string fileUrl = "https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3";

    protected override void OnInitialized()
    {
        Hub.QuestionPushed += OnQuestionPushed;
    }

    private async void OnQuestionPushed(Nuotti.Contracts.QuestionPushed _)
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        Hub.QuestionPushed -= OnQuestionPushed;
    }

    private async Task Submit(int index)
    {
        await Hub.SubmitAnswerAsync(index);
    }

    private async Task RequestPlay()
    {
        await Hub.RequestPlayAsync(fileUrl);
    }

    private void GoHome()
    {
        // Navigate back to join page
        Nav.NavigateTo("/");
    }
}
