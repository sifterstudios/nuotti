@page "/"
@using Nuotti.Audience.Services
@inject AudienceHubClient Hub
@inject NavigationManager Nav

<PageTitle>Join session</PageTitle>

<div class="container py-4" style="max-width: 520px;">
    <h1 class="h3 mb-3">Join a session</h1>

    <div class="mb-3">
        <label class="form-label" for="sessionInput">Session code</label>
        <input id="sessionInput" class="form-control form-control-lg" @bind="session" placeholder="e.g. ABC123" />
    </div>

    <div class="mb-4">
        <label class="form-label" for="nameInput">Your name (optional)</label>
        <input id="nameInput" class="form-control form-control-lg" @bind="name" placeholder="Jane" />
    </div>

    <button class="btn btn-primary btn-lg w-100" @onclick="JoinAsync" disabled="@(isBusy || string.IsNullOrWhiteSpace(session))">
        @(isBusy ? "Joining..." : "Join")
    </button>

    @if (!string.IsNullOrWhiteSpace(error))
    {
        <div class="alert alert-danger mt-3" role="alert">@error</div>
    }

    <div class="text-muted small mt-4">
        Backend: @Hub.BackendBaseUrl
    </div>
</div>

@code {
    private string session = string.Empty;
    private string? name;
    private bool isBusy;
    private string? error;

    protected override void OnInitialized()
    {
        Hub.QuestionPushed += OnQuestion;
    }

    private void OnQuestion(Nuotti.Contracts.QuestionPushed q)
    {
        // Navigate to question screen when a question is pushed
        Nav.NavigateTo("/question");
    }

    private async Task JoinAsync()
    {
        error = null;
        isBusy = true;
        try
        {
            await Hub.CreateOrJoinAsync(session.Trim(), string.IsNullOrWhiteSpace(name) ? null : name!.Trim());
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }
}