@using Microsoft.AspNetCore.Components.Routing
@inherits LayoutComponentBase
@inject ThemeService ThemeService

<MudThemeProvider @ref="@_mudThemeProvider" Theme="@_theme" IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider Position="SnackbarPosition.BottomRight" MaxDisplayedSnackbars="5" PreventDuplicates="true" />

<MudLayout>
    <MudAppBar Elevation="0" Dense="true" Style="backdrop-filter: blur(10px);">
        <MudIconButton Icon="@Material.Filled.Menu" 
                       Color="Color.Inherit" 
                       Edge="Edge.Start" 
                       OnClick="@ToggleDrawer"
                       Size="Size.Large" />
        <MudText Typo="Typo.h5" Style="font-weight: 700; margin-left: 12px;">
            🎵 Nuotti Performer
        </MudText>
        <MudSpacer />
        <LiveHeader />
        <MudTooltip Text="Show command history">
            <MudIconButton Icon="@Material.Filled.History"
                           Color="Color.Inherit"
                           OnClick="ToggleHistory"
                           Size="Size.Large"
                           Class="ml-2" />
        </MudTooltip>
        <MudTooltip Text="@(_isDarkMode ? "Switch to light mode" : "Switch to dark mode")">
            <MudIconButton Icon="@(_isDarkMode ? Material.Filled.LightMode : Material.Filled.DarkMode)" 
                           Color="Color.Inherit"
                           OnClick="ToggleTheme"
                           Size="Size.Large"
                           Class="ml-2" />
        </MudTooltip>
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" Elevation="2" ClipMode="DrawerClipMode.Docked">
        <MudDrawerHeader>
            <div>
                <MudText Typo="Typo.h5" Style="font-weight: 700;">🎵 Nuotti</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Performance Control</MudText>
            </div>
        </MudDrawerHeader>
        <MudNavMenu>
            <MudNavLink Href="/" 
                        Match="NavLinkMatch.All" 
                        Icon="@Material.Filled.Dashboard">
                Dashboard
            </MudNavLink>
            <MudNavLink Href="/setlist" 
                        Match="NavLinkMatch.Prefix" 
                        Icon="@Material.Filled.QueueMusic">
                Setlist Manager
            </MudNavLink>
            <MudDivider Class="my-2" />
            <MudNavGroup Title="Settings" Icon="@Material.Filled.Settings" Expanded="false">
                <MudNavLink Icon="@Material.Filled.Info">About</MudNavLink>
                <MudNavLink Icon="@(_isDarkMode ? Material.Filled.LightMode : Material.Filled.DarkMode)" 
                            OnClick="ToggleTheme">
                    @(_isDarkMode ? "Light" : "Dark") Mode
                </MudNavLink>
            </MudNavGroup>
        </MudNavMenu>
    </MudDrawer>

    <MudDrawer Anchor="Anchor.Right" @bind-Open="_historyOpen" Elevation="2">
        <CommandHistoryDrawer />
    </MudDrawer>

    <MudMainContent Class="mt-2">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="my-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _historyOpen = false;
    private MudThemeProvider? _mudThemeProvider;
    private MudTheme _theme = null!;
    private bool _isDarkMode;

    protected override void OnInitialized()
    {
        _theme = ThemeService.GetTheme();
        _isDarkMode = ThemeService.IsDarkMode;
        ThemeService.OnThemeChanged += OnThemeChanged;
    }

    private void OnThemeChanged()
    {
        _isDarkMode = ThemeService.IsDarkMode;
        InvokeAsync(StateHasChanged);
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void ToggleHistory()
    {
        _historyOpen = !_historyOpen;
    }

    private void ToggleTheme()
    {
        ThemeService.ToggleTheme();
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= OnThemeChanged;
    }
}
